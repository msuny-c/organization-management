<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(~{::title}, ~{::main})}">
<head>
    <title>Специальные операции</title>
</head>
<body>
    <main th:fragment="content">
        <div class="mb-5">
            <h1 class="mb-2"><i class="bi bi-tools me-2"></i>Специальные операции</h1>
            <p class="text-muted">Расширенный функционал для работы с организациями</p>
        </div>

        <section class="mb-5">
            <h2 class="mb-4"><i class="bi bi-search me-2"></i>Поиск и запросы</h2>
            <div class="row g-4">
                <div class="col-lg-6">
                    <div class="operation-card">
                        <div class="operation-icon">
                            <i class="bi bi-geo-alt"></i>
                        </div>
                        <h3 class="operation-title">Минимальные координаты</h3>
                        <p class="operation-description">Найти организацию с минимальными координатами (сначала по X, затем по Y)</p>
                        
                        <form th:action="@{/operations/minimal-coordinates}" method="post">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-search me-2"></i>Найти
                            </button>
                        </form>
                    </div>

                    <div class="mt-3" th:if="${minimalOrganization}">
                        <div class="result-card">
                            <div class="result-card-title">
                                <i class="bi bi-check-circle-fill"></i>
                                Найдена организация
                            </div>
                            <h4 class="mb-3" th:text="${minimalOrganization.name}"></h4>
                            <div class="mb-2">
                                <strong>ID:</strong> <span th:text="${minimalOrganization.id}" class="badge bg-primary"></span>
                            </div>
                            <div class="mb-3">
                                <strong>Координаты:</strong> 
                                X: <span th:text="${minimalOrganization.coordinates?.x}"></span>, 
                                Y: <span th:text="${minimalOrganization.coordinates?.y}"></span>
                            </div>
                            <a th:href="@{/organizations/{id}(id=${minimalOrganization.id})}" class="btn btn-outline-primary">
                                <i class="bi bi-eye me-2"></i>Подробнее
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="mb-5">
            <h2 class="mb-4"><i class="bi bi-bar-chart me-2"></i>Статистика и аналитика</h2>
            <div class="row g-4">
                <div class="col-lg-6">
                    <div class="operation-card">
                        <div class="operation-icon">
                            <i class="bi bi-bar-chart"></i>
                        </div>
                        <h3 class="operation-title">Группировка по рейтингу</h3>
                        <p class="operation-description">Сгруппировать организации по рейтингу и показать количество в каждой группе</p>
                        
                        <form th:action="@{/operations/group-by-rating}" method="post">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-diagram-3 me-2"></i>Группировать
                            </button>
                        </form>
                    </div>

                    <div class="mt-3" th:if="${ratingGroups}">
                        <div class="result-card">
                            <div class="result-card-title">
                                <i class="bi bi-check-circle-fill"></i>
                                Группировка по рейтингу
                            </div>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Рейтинг</th>
                                            <th>Количество организаций</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="entry : ${ratingGroups}">
                                            <td>
                                                <span th:text="${entry.key}" class="badge bg-warning text-dark"></span>
                                            </td>
                                            <td>
                                                <strong th:text="${entry.value}"></strong>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="operation-card">
                        <div class="operation-icon">
                            <i class="bi bi-list-ol"></i>
                        </div>
                        <h3 class="operation-title">Подсчет по типу</h3>
                        <p class="operation-description">Подсчитать количество организаций с указанным типом</p>
                        
                        <form th:action="@{/operations/count-by-type}" method="post">
                            <div class="mb-3">
                                <label for="type" class="form-label">Выберите тип</label>
                                <select class="form-select" id="type" name="type" required>
                                    <option value="" selected disabled>Выберите тип...</option>
                                    <option th:each="type : ${T(com.example.organization.model.OrganizationType).values()}" 
                                            th:value="${type}" 
                                            th:text="${type}"></option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-calculator me-2"></i>Подсчитать
                            </button>
                        </form>
                    </div>

                    <div class="mt-3" th:if="${typeCount != null}">
                        <div class="result-card">
                            <div class="result-card-title">
                                <i class="bi bi-check-circle-fill"></i>
                                Результат подсчета
                            </div>
                            <h3 class="mb-0">
                                Тип <span th:text="${selectedType}" class="badge bg-secondary"></span>: 
                                <strong th:text="${typeCount}"></strong> организаций
                            </h3>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="mb-5">
            <h2 class="mb-4"><i class="bi bi-gear me-2"></i>Управление организациями</h2>
            <div class="row g-4">
                <div class="col-lg-6">
                    <div class="operation-card" style="border-left: 4px solid var(--warning-color);">
                        <div class="operation-icon" style="background: rgba(255, 149, 0, 0.1); color: var(--warning-color);">
                            <i class="bi bi-person-x"></i>
                        </div>
                        <h3 class="operation-title">Увольнение сотрудников</h3>
                        <p class="operation-description">Уволить всех сотрудников организации (установить количество в 0)</p>
                        
                        <form th:action="@{/operations/dismiss-employees}" method="post">
                            <div class="mb-3">
                                <label for="organizationId" class="form-label">ID организации</label>
                                <input type="number" 
                                       class="form-control" 
                                       id="organizationId" 
                                       name="organizationId" 
                                       min="1" 
                                       placeholder="Введите ID"
                                       required>
                            </div>
                            <button type="submit" class="btn btn-warning w-100">
                                <i class="bi bi-person-x me-2"></i>Уволить всех
                            </button>
                        </form>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="operation-card" style="border-left: 4px solid var(--danger-color);">
                        <div class="operation-icon" style="background: rgba(220, 53, 69, 0.1); color: var(--danger-color);">
                            <i class="bi bi-arrow-down-up"></i>
                        </div>
                        <h3 class="operation-title">Поглощение организации</h3>
                        <p class="operation-description">Поглотить одну организацию другой (сотрудники переходят, поглощаемая удаляется)</p>
                        
                        <form th:action="@{/operations/absorb}" method="post">
                            <div class="row g-3 mb-3">
                                <div class="col-6">
                                    <label for="absorbingId" class="form-label">Поглощающая (ID)</label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="absorbingId" 
                                           name="absorbingId" 
                                           min="1" 
                                           placeholder="ID"
                                           required>
                                </div>
                                <div class="col-6">
                                    <label for="absorbedId" class="form-label">Поглощаемая (ID)</label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="absorbedId" 
                                           name="absorbedId" 
                                           min="1" 
                                           placeholder="ID"
                                           required>
                                </div>
                            </div>
                            <div class="alert alert-danger mt-2" id="absorbError" style="display: none; margin-bottom: 1rem;">
                                <i class="bi bi-exclamation-triangle me-2"></i>Организация не может поглотить саму себя
                            </div>
                            <button type="submit" class="btn btn-danger w-100">
                                <i class="bi bi-arrow-down-up me-2"></i>Поглотить
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const absorbForm = document.querySelector('form[action*="/absorb"]');
            if (absorbForm) {
                const absorbingInput = document.getElementById('absorbingId');
                const absorbedInput = document.getElementById('absorbedId');
                const errorDiv = document.getElementById('absorbError');
                
                function validateAbsorbForm() {
                    const absorbingId = absorbingInput.value;
                    const absorbedId = absorbedInput.value;
                    
                    if (absorbingId && absorbedId && absorbingId === absorbedId) {
                        absorbingInput.classList.add('is-invalid');
                        absorbedInput.classList.add('is-invalid');
                        errorDiv.style.display = 'block';
                        return false;
                    } else {
                        absorbingInput.classList.remove('is-invalid');
                        absorbedInput.classList.remove('is-invalid');
                        errorDiv.style.display = 'none';
                        return true;
                    }
                }
                
                absorbingInput.addEventListener('input', validateAbsorbForm);
                absorbedInput.addEventListener('input', validateAbsorbForm);
                
                absorbForm.addEventListener('submit', function(e) {
                    if (!validateAbsorbForm()) {
                        e.preventDefault();
                    }
                });
            }
        });
    </script>
</body>
</html>
